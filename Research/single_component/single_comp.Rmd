---
title: "MLDS Research Project"
subtitle: "Single Component Study"
output:
  html_document:
    toc: true
    toc_depth: 2
    theme: united
    number_sections: true
date: "8th August 2023"
geometry: "left=1cm,right=1cm,top=1cm,bottom=2cm"
author: "James Lee (CID: 01185042)"
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
setwd("~/coding/mlds-final-project/Research/single_component")
```

Imports
```{r imports}
library(tidyverse)
library(glue)
library(rlist)
library(rhdf5)
library(reshape2)

library(mvtnorm)
library(LaplacesDemon)
library(sn)

library(ggpubr)
library(gridExtra)

set.seed(0)
```



# Skew Normal

## Create a single skew normal distribution
### 1D
$$
x_i \sim \mathrm{SkewNormal}(\xi, \omega, \alpha) \quad i=1, \ldots, n
$$
where
$$
\omega = 1 \quad \xi = 0 \quad \alpha \in \{0, 1, 2, 5, 7\} \quad n=10^4
$$

```{r}
omega = 1
alphas = c(0, 1, 2, 5, 7)
xi = 0
n = 10000

for (alpha in alphas) {
  for (set in 1:50) {
    data = rsn(n = n, xi = xi, omega = omega, alpha = alpha)
    save_name = glue("./data_inputs/skew_norm/1d/single_skew_normal_1d-alpha={alpha}-set-{set}.jld")
    # h5save(data, file = save_name, name = "data")
  }
}

plot_created_data = list()
for (alpha in alphas) {
  for (set in 1:3) {
    
    read_name = glue("./data_inputs/skew_norm/1d/single_skew_normal_1d-alpha={alpha}-set-{set}.jld")
    df = as.data.frame(h5read(read_name, "data"))
    colnames(df) = c("x")
    plot_created_data[[read_name]] = df %>% ggplot(aes(x = x)) + 
      geom_histogram(bins = 20, fill = "#619cff", color = "#000000", alpha = 0.9) + 
      ggtitle(glue("alpha={alpha} - set={set}")) +
      theme(plot.title = element_text(size = 10))
  }
}

p = do.call("grid.arrange", c(plot_created_data, ncol = 3))
ggsave(
  "./plots/single_skew_normal_1d_examples.pdf",
  p,
  width = 6,
  height = 10,
  dpi = 600,
  units = "in",
  device = "pdf"
)
```

### 2D
$$
x_i \sim \mathrm{SkewNormal}_2(\xi, \Omega, \alpha) \quad i=1, \ldots, n
$$
where
$$
\Omega = \begin{pmatrix}1 & 0 \\ 0 & 1\end{pmatrix} \quad \alpha = (\beta, \beta) \quad \xi = (0, 0) \quad n=10^4
$$
where
$$
\beta \in \{0, 1, 2, 5, 7\}
$$

```{r}
Omega = matrix(c(1, 0, 0, 1), nrow = 2, ncol = 2)
alphas = c(0, 1, 2, 5, 7)
xi = c(0, 0)
n = 10000

for (alpha in alphas) {
  for (set in 1:50) {
    data = rmsn(n = n, xi = xi, Omega = Omega, alpha = c(alpha, alpha))
    save_name = glue("./data_inputs/skew_norm/2d/single_skew_normal_2d-alpha={alpha}-set-{set}.jld")
    # h5save(data, file = save_name, name = "data")
  }
}

plot_created_data <- list()
for (alpha in alphas) {
  for (set in 1:3) {
    read_name = glue("./data_inputs/skew_norm/2d/single_skew_normal_2d-alpha={alpha}-set-{set}.jld")
    
    plot_created_data[[read_name]]

    df = as.data.frame(h5read(read_name, "data"))
    colnames(df) = c("x", "y")
    plot_created_data[[read_name]] = df %>% ggplot(aes(x = x, y = y)) +
      geom_point(size = 0.1, color="#619CFF") + 
      ggtitle(glue("alpha={alpha} - set={set}")) +
      theme(plot.title = element_text(size = 10))
  }
}

p = do.call("grid.arrange", c(plot_created_data, ncol = 3))
ggsave(
  "./plots/single_skew_normal_2d_examples.pdf",
  p,
  width = 6,
  height = 10,
  dpi = 600,
  units = "in",
  device = "pdf"
)
```


## Simulation Results

From the simulation results, we can see that with increasing $\alpha$, the posterior on the number
of components is increasingly inconsistent.

```{r}
sets = 1:50
ns = c(100, 250, 500, 750, 1000, 1500, 2500, 5000, 7500, 10000)
m = 10
K_0 = 2

plot_avg_map_k <- function(alpha, ns, m, K_0, dim) {
  pmf = matrix(NA, nrow = m, ncol = length(sets))
  avg_map_k = rep(NA, length(ns))
  
  for (i_n in seq_along(ns)) {
    n = ns[i_n]
    
    for (i_set in seq_along(sets)) {
      set = sets[i_set]
      filename = glue("./comp_outputs/skew_norm/{dim}d/k_posterior-single_skew_normal_{dim}d-alpha={alpha}-n={n}-set-{set}.jld")
      k_posterior = h5read(filename, "k_posterior")
      pmf[, i_set] = k_posterior[1:m]
    }
    
    # df = as.data.frame(cbind(1:m, pmf))
    # colnames(df) = c("k", sets)
    # long_df = melt(df,  id.vars = "k", variable.name = "series")
    # colnames(long_df) = c("k", "set", "pmf")
    # 
    # pmf_plot = long_df %>%
    #   ggplot(aes(x = k, y = pmf)) +
    #   geom_line(aes(colour = set), linewidth = 1) +
    #   geom_point(aes(color = set)) +
    #   geom_vline(xintercept = K_0, linetype = "dotted", linewidth = 1.5) +
    #   scale_x_continuous(name = "k", breaks = 1:m) +
    #   ggtitle(glue("MFM - Skew Normal Mixtures - 1 component - n={n}")) +
    #   scale_color_grey(start=0.7, end=0)
    # print(pmf_plot)
    
    map_k = apply(pmf, 2, which.max)
    avg_map_k[i_n] = mean(map_k)
  }
  return(avg_map_k)
}

alphas = c(0, 1, 2, 5, 7)
df = as.data.frame(
  cbind(
    ns,
    plot_avg_map_k(0, ns, m, K_0, 1),
    plot_avg_map_k(1, ns, m, K_0, 1),
    plot_avg_map_k(2, ns, m, K_0, 1),
    plot_avg_map_k(5, ns, m, K_0, 1),
    plot_avg_map_k(7, ns, m, K_0, 1)
  )
)
colnames(df) <- c("n", alphas)
long_df = melt(df,  id.vars = "n", variable.name = "alpha")
colnames(long_df) = c("n", "alpha", "avg_map_k")
pmf_plot_1d = long_df %>%
  ggplot(aes(x = log(n), y = avg_map_k)) +
  geom_line(aes(colour = alpha), linewidth = 1) +
  geom_point(aes(color = alpha)) +
  scale_color_grey(start=0.7, end=0) +
  scale_x_continuous(name = "log(n)") +
  scale_y_continuous("Mean MAP-k", 1:6) +
  ggtitle("1D")

ns = c(100, 250, 500, 1000, 1500, 2500, 5000, 7500, 10000)
df = as.data.frame(
  cbind(
    ns,
    plot_avg_map_k(0, ns, m, K_0, 2),
    plot_avg_map_k(1, ns, m, K_0, 2),
    plot_avg_map_k(2, ns, m, K_0, 2),
    plot_avg_map_k(5, ns, m, K_0, 2),
    plot_avg_map_k(7, ns, m, K_0, 2)
  )
)
colnames(df) <- c("n", alphas)
long_df = melt(df,  id.vars = "n", variable.name = "alpha")
colnames(long_df) = c("n", "alpha", "avg_map_k")
pmf_plot_2d = long_df %>%
  ggplot(aes(x = log(n), y = avg_map_k)) +
  geom_line(aes(colour = alpha), linewidth = 1) +
  geom_point(aes(color = alpha)) +
  scale_color_grey(start = 0.7, end = 0) +
  scale_x_continuous(name = "log(n)") +
  scale_y_continuous("Mean MAP-k", 1:6) +
  ggtitle("2D")

p = ggarrange(pmf_plot_1d, pmf_plot_2d, ncol = 2)
ggsave("./plots/single_skew_normal_results.pdf", p, width=10, height=5, units="in", dpi=600, device="pdf")
```

# Single Laplace component

## Create data
### 2D
```{r}
ss = c(1, 2, 3, 4, 5)
mu = c(0, 0)
n = 10000

for (s in ss) {
  sigma =  matrix(c(s, 0, 0, s), nrow = 2, ncol = 2)
  for (set in 1:50) {
    data = rmvl(n = n, mu=mu, Sigma = sigma)
    save_name = glue("./data_inputs/laplace/2d/single_laplace_2d-sigma={s}-set-{set}.jld")
    # h5save(data, file = save_name, name = "data")
  }
}

plot_created_data <- list()
for (s in ss) {
  for (set in 1:3) {
    read_name = glue("./data_inputs/laplace/2d/single_laplace_2d-sigma={s}-set-{set}.jld")
    
    plot_created_data[[read_name]]

    df = as.data.frame(h5read(read_name, "data"))
    colnames(df) = c("x", "y")
    plot_created_data[[read_name]] = df %>% ggplot(aes(x = x, y = y)) +
      geom_point(size = 0.1, color="#619CFF") + 
      ggtitle(glue("sigma={s} - set={set}")) +
      theme(plot.title = element_text(size = 10))
  }
}

p = do.call("grid.arrange", c(plot_created_data, ncol = 3))
ggsave(
  "./plots/single_laplace_2d_examples.pdf",
  p,
  width = 6,
  height = 10,
  dpi = 600,
  units = "in",
  device = "pdf"
)
```

### 1D
```{r}
lambdas = c(1, 2, 3, 4, 5)
mu = 0
n = 10000

for (lambda in lambdas) {
  for (set in 1:50) {
    data = rlaplace(n = n, location = mu, scale = lambda)
    save_name = glue("./data_inputs/laplace/1d/single_laplace_1d-lambda={lambda}-set-{set}.jld")
    # h5save(data, file = save_name, name = "data")
  }
  read_name = glue("./data_inputs/laplace/1d/single_laplace_1d-lambda={lambda}-set-8.jld")
  df = as.data.frame(h5read(read_name, "data"))
  colnames(df) = c("x")
  p = df %>% ggplot(aes(x = x)) + 
    geom_histogram(bins = 50, fill = "#619cff", color = "#000000") + 
    ggtitle(glue("Single 1D Laplace Component - lambda={lambda}"))
  print(p)
}

plot_created_data <- list()
for (lambda in lambdas) {
  for (set in 1:3) {
    read_name = glue("./data_inputs/laplace/1d/single_laplace_1d-lambda={lambda}-set-{set}.jld")
    
    plot_created_data[[read_name]]

    df = as.data.frame(h5read(read_name, "data"))
    colnames(df) = c("x")
    plot_created_data[[read_name]] = df %>% ggplot(aes(x = x)) + 
      geom_histogram(bins = 50, fill = "#619cff", color = "#000000") + 
      ggtitle(glue("lambda={lambda} - set-{set}")) +
      theme(plot.title = element_text(size = 10))
  }
}

p = do.call("grid.arrange", c(plot_created_data, ncol = 3))
ggsave(
  "./plots/single_laplace_1d_examples.pdf",
  p,
  width = 6,
  height = 10,
  dpi = 600,
  units = "in",
  device = "pdf"
)
```

### Laplace results
```{r}
sets = 1:50
ns = c(100, 250, 500, 750, 1000, 1500, 2500, 5000, 7500, 10000)
m = 10
K_0 = 1

plot_avg_map_k <- function(alpha, ns, m, K_0, dim) {
  pmf = matrix(NA, nrow = m, ncol = length(sets))
  avg_map_k = rep(NA, length(ns))
  
  for (i_n in seq_along(ns)) {
    n = ns[i_n]
    
    for (i_set in seq_along(sets)) {
      set = sets[i_set]
      filename = glue("./comp_outputs/laplace/{dim}d/k_posterior-single_laplace_{dim}d-lambda={alpha}-n={n}-set-{set}.jld")
      k_posterior = h5read(filename, "k_posterior")
      pmf[, i_set] = k_posterior[1:m]
    }
    
    df = as.data.frame(cbind(1:m, pmf))
    colnames(df) = c("k", sets)
    long_df = melt(df,  id.vars = "k", variable.name = "series")
    colnames(long_df) = c("k", "set", "pmf")
  
    pmf_plot = long_df %>%
      ggplot(aes(x = k, y = pmf)) +
      geom_line(aes(colour = set), linewidth = 1) +
      geom_point(aes(color = set)) +
      geom_vline(xintercept = K_0, linetype = "dotted", linewidth = 1.5) +
      scale_x_continuous(name = "k", breaks = 1:m) +
      ggtitle(glue("MFM - 1D Laplace - 1 component - n={n}")) +
      scale_color_grey(start=0.7, end=0)
    # print(pmf_plot)
    map_k = apply(pmf, 2, which.max)
    avg_map_k[i_n] = mean(map_k)
  }
  return(avg_map_k)
}


alphas = c(1, 2, 3, 4, 5)
df = as.data.frame(
  cbind(
    ns,
    plot_avg_map_k(1, ns, m, K_0, 1),
    plot_avg_map_k(2, ns, m, K_0, 1),
    plot_avg_map_k(3, ns, m, K_0, 1),
    plot_avg_map_k(4, ns, m, K_0, 1),
    plot_avg_map_k(5, ns, m, K_0, 1)
  )
)
colnames(df) <- c("n", alphas)
long_df = melt(df,  id.vars = "n", variable.name = "alpha")
colnames(long_df) = c("n", "lambda", "avg_map_k")
pmf_plot_1d = long_df %>%
  ggplot(aes(x = n, y = avg_map_k)) +
  geom_line(aes(colour = lambda), linewidth = 1) +
  geom_point(aes(color = lambda)) +
  scale_x_continuous(name = "n") +
  scale_color_grey(start=0.7, end=0)
print(pmf_plot_1d)
# 
# 


plot_avg_map_k <- function(alpha, ns, m, K_0, dim) {
  pmf = matrix(NA, nrow = m, ncol = length(sets))
  avg_map_k = rep(NA, length(ns))
  
  for (i_n in seq_along(ns)) {
    n = ns[i_n]
    
    for (i_set in seq_along(sets)) {
      set = sets[i_set]
      filename = glue("./comp_outputs/laplace/{dim}d/k_posterior-single_laplace_{dim}d-sigma={alpha}-n={n}-set-{set}.jld")
      k_posterior = h5read(filename, "k_posterior")
      pmf[, i_set] = k_posterior[1:m]
    }
    
    df = as.data.frame(cbind(1:m, pmf))
    colnames(df) = c("k", sets)
    long_df = melt(df,  id.vars = "k", variable.name = "series")
    colnames(long_df) = c("k", "set", "pmf")
  
    pmf_plot = long_df %>%
      ggplot(aes(x = k, y = pmf)) +
      geom_line(aes(colour = set), linewidth = 1) +
      geom_point(aes(color = set)) +
      geom_vline(xintercept = K_0, linetype = "dotted", linewidth = 1.5) +
      scale_x_continuous(name = "k", breaks = 1:m) +
      ggtitle(glue("MFM - 1D Laplace - 1 component - n={n}")) +
      scale_color_grey(start=0.7, end=0)
    # print(pmf_plot)
    map_k = apply(pmf, 2, which.max)
    avg_map_k[i_n] = mean(map_k)
  }
  return(avg_map_k)
}

ns = c(100, 250, 500, 750, 1000, 1500, 2500)
alphas = c(1, 2, 3, 4, 5)
df = as.data.frame(
  cbind(
    ns,
    plot_avg_map_k(1, ns, m, K_0, 2),
    plot_avg_map_k(2, ns, m, K_0, 2),
    plot_avg_map_k(3, ns, m, K_0, 2),
    plot_avg_map_k(4, ns, m, K_0, 2),
    plot_avg_map_k(5, ns, m, K_0, 2)
  )
)
colnames(df) <- c("n", alphas)
long_df = melt(df,  id.vars = "n", variable.name = "alpha")
colnames(long_df) = c("n", "lambda", "avg_map_k")
pmf_plot_2d = long_df %>%
  ggplot(aes(x = n, y = avg_map_k)) +
  geom_line(aes(colour = lambda), linewidth = 1) +
  geom_point(aes(color = lambda)) +
  scale_x_continuous(name = "n") +
  scale_color_grey(start=0.7, end=0)
print(pmf_plot_2d)

ggarrange(pmf_plot_1d, pmf_plot_2d, nrow = 2)
```



```{r}
ss = c(0, 1, 2, 3)
n = 10000

for (s in ss) {
  for (set in 1:50) {
    df = 10^s
    data = rst(n = n, xi = 0, omega = 1, alpha = 0, nu = df)
    save_name = glue("./data_inputs/skew_t/1d/single_skew_t_1d-s={s}-set-{set}.jld")
    # h5save(data, file = save_name, name = "data")
  }
  # read_name = glue("./data_inputs/skew_t/1d/single_skew_t_1d-s={s}-set-8.jld")
  # df = as.data.frame(h5read(read_name, "data"))
  df = as.data.frame(data)
  colnames(df) = c("x")
  p = df %>% ggplot(aes(x = x)) + 
    geom_histogram(bins = 50) + 
    ggtitle(glue("Single 1D Skew t Component - s={s}"))
  print(p)
}
```

```{r}
plot_avg_map_k <- function(s, ns, m, K_0, dim) {
  pmf = matrix(NA, nrow = m, ncol = length(sets))
  avg_map_k = rep(NA, length(ns))
  
  for (i_n in seq_along(ns)) {
    n = ns[i_n]
    
    for (i_set in seq_along(sets)) {
      set = sets[i_set]
      filename = glue("./comp_outputs/student_t/{dim}d/k_posterior-single_student_t_{dim}d-s={s}-n={n}-set-{set}.jld")
      k_posterior = h5read(filename, "k_posterior")
      pmf[, i_set] = k_posterior[1:m]
    }
    
    df = as.data.frame(cbind(1:m, pmf))
    colnames(df) = c("k", sets)
    long_df = melt(df,  id.vars = "k", variable.name = "series")
    colnames(long_df) = c("k", "set", "pmf")
  
    pmf_plot = long_df %>%
      ggplot(aes(x = k, y = pmf)) +
      geom_line(aes(colour = set), linewidth = 1) +
      geom_point(aes(color = set)) +
      geom_vline(xintercept = K_0, linetype = "dotted", linewidth = 1.5) +
      scale_x_continuous(name = "k", breaks = 1:m) +
      ggtitle(glue("MFM - 1D Laplace - 1 component - n={n}")) +
      scale_color_grey(start = 0.7, end = 0)
    # print(pmf_plot)
    map_k = apply(pmf, 2, which.max)
    avg_map_k[i_n] = mean(map_k)
  }
  return(avg_map_k)
}

sets = 1:50
ns = c(100, 250, 500, 750)
m = 10
K_0 = 1
alphas = c(0, 2, 4, 6, 8, 10)
df = as.data.frame(
  cbind(
    ns,
    plot_avg_map_k(0, ns, m, K_0, 1),
    plot_avg_map_k(2, ns, m, K_0, 1),
    plot_avg_map_k(4, ns, m, K_0, 1),
    plot_avg_map_k(6, ns, m, K_0, 1),
    plot_avg_map_k(8, ns, m, K_0, 1),
    plot_avg_map_k(10, ns, m, K_0, 1)
  )
)
colnames(df) <- c("n", alphas)
long_df = melt(df,  id.vars = "n", variable.name = "alpha")
colnames(long_df) = c("n", "lambda", "avg_map_k")
pmf_plot = long_df %>%
  ggplot(aes(x = n, y = avg_map_k)) +
  geom_line(aes(colour = lambda), linewidth = 1) +
  geom_point(aes(color = lambda)) +
  scale_x_continuous(name = "n") +
  scale_color_grey(start=0.7, end=0)
print(pmf_plot)
```

```{r}
n = 1000
Omega = matrix(data = c(1, 0, 0, 1), nrow = 2)

data_1 = rmsn(n = n, xi = c(0, 0), Omega = Omega, alpha = c(7, 7))
data_2 = rmsn(n = n, xi = c(3, 0), Omega = Omega, alpha = c(7, 7))
data = rbind(data_1, data_2)
df = as.data.frame(data)
colnames(df) = c("x", "y")
df %>% ggplot(aes(x = x, y = y)) + geom_point()
```
